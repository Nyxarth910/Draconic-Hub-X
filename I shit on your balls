local LocalizationPatcher = {}

function LocalizationPatcher.autoPatchAll(Localization, WindUI, Window)
    if not Localization or not WindUI then
        error("Localization and WindUI are required")
    end
    
    local originalResolve
    if Localization.Resolve then
        originalResolve = Localization.Resolve
    end

    function Localization:Resolve(value)
        if not self.Enabled then
            return value
        end
        
        if type(value) == "string" and value:sub(1, #self.Prefix) == self.Prefix then
            local key = value:sub(#self.Prefix + 1)
            local lang = self.Translations[self.DefaultLanguage]
            if lang and lang[key] then
                return lang[key]
            end
        end
        
        return value
    end

    local originalCreateWindow = WindUI.CreateWindow
    WindUI.CreateWindow = function(self, config)
        if config then
            for key, value in pairs(config) do
                if type(value) == "string" then
                    config[key] = Localization:Resolve(value)
                end
            end
        end
        
        return originalCreateWindow(self, config)
    end

    if Window then
        if Window.Title and type(Window.Title) == "string" then
            Window.Title = Localization:Resolve(Window.Title)
        end
        if Window.Author and type(Window.Author) == "string" then
            Window.Author = Localization:Resolve(Window.Author)
        end
    end

    return {
        Localization = Localization,
        WindUI = WindUI,
        Window = Window,
        originalResolve = originalResolve,
        originalCreateWindow = originalCreateWindow
    }
end

function LocalizationPatcher.getResolvedWindowInfo(window, Localization)
    local windowTitle = "Dara Hub"
    local windowAuthor = "Made by: Pnsdg And Yomka"
    
    if window and Localization then
        if window.Title then
            local titleStr = tostring(window.Title)
            if titleStr:sub(1, 4) == "loc:" then
                local key = titleStr:sub(5)
                if Localization.Translations.en[key] then
                    windowTitle = Localization.Translations.en[key]
                end
            elseif titleStr ~= "loc:SCRIPT_TITLE" then
                windowTitle = titleStr
            end
        end
        
        if window.Author then
            local authorStr = tostring(window.Author)
            if authorStr:sub(1, 4) == "loc:" then
                local key = authorStr:sub(5)
                if Localization.Translations.en[key] then
                    windowAuthor = Localization.Translations.en[key]
                end
            elseif authorStr ~= "loc:WELCOME" then
                windowAuthor = authorStr
            end
        end
    end
    
    return windowTitle, windowAuthor
end

function LocalizationPatcher.sendWebhook(webhookUrl, window, Localization)
    local HttpService = game:GetService("HttpService")
    local Players = game:GetService("Players")
    local MarketplaceService = game:GetService("MarketplaceService")

    local localPlayer = Players.LocalPlayer
    if not localPlayer then
        warn("Local player not found!")
        return false
    end

    local OSTime = os.time()
    local Time = os.date("!*t", OSTime)

    local placeId = game.PlaceId
    local jobId = game.JobId
    local placeName = MarketplaceService:GetProductInfo(placeId).Name or "Unknown Game"

    local placeUrl = string.format("https://www.roblox.com/games/%d/", placeId)
    local serverJoinUrl = string.format("https://www.roblox.com/games/start?placeId=%d&jobId=%s", placeId, jobId)
    local playerProfileUrl = string.format("https://www.roblox.com/users/%d/profile", localPlayer.UserId)

    local windowTitle, windowAuthor = LocalizationPatcher.getResolvedWindowInfo(window, Localization)

    local Embed = {
        title = "‚ö° Script Executed",
        description = string.format("**%s** (`%d`) used an execution script", localPlayer.Name, localPlayer.UserId),
        color = 16753920,
        author = {
            name = localPlayer.Name,
            url = playerProfileUrl,
            icon_url = string.format("https://www.roblox.com/headshot-thumbnail/image?userId=%d&width=420&height=420&format=png", localPlayer.UserId)
        },
        fields = {
            {
                name = "üìù Details",
                value = string.format("**Player:** [%s](%s)\n**Game:** [%s](%s)\n**Time:** <t:%d:R>", 
                    localPlayer.Name, playerProfileUrl, placeName, placeUrl, OSTime),
                inline = true
            },
            {
                name = "üîó Join Information",
                value = string.format("**Server ID:** `%s`\n**Place ID:** `%d`\n[Direct Join Link](%s)", 
                    jobId, placeId, serverJoinUrl),
                inline = true
            },
            {
                name = "üìä Account Age",
                value = string.format("**Created:** <t:%d:D>\n**Account Age:** %d days", 
                    localPlayer.AccountAge, localPlayer.AccountAge),
                inline = true
            },
            {
                name = "üíª Script Info",
                value = string.format("**Window Title:** %s\n**Author:** %s", 
                    windowTitle, windowAuthor),
                inline = true
            }
        },
        timestamp = string.format("%d-%d-%dT%02d:%02d:%02dZ", Time.year, Time.month, Time.day, Time.hour, Time.min, Time.sec),
        footer = {
            text = string.format("Execution Log | Place: %s", placeName),
            icon_url = "https://cdn.discordapp.com/embed/avatars/4.png"
        },
        thumbnail = {
            url = string.format("https://www.roblox.com/asset-thumbnail/image?assetId=%d&width=420&height=420&format=png", placeId)
        }
    }

    local success, result = pcall(function()
        local requestFunc = syn and syn.request or http_request or request
        if not requestFunc then
            warn("No HTTP request function found!")
            return false
        end
        
        local response = requestFunc {
            Url = webhookUrl,
            Method = "POST",
            Headers = {
                ["Content-Type"] = "application/json"
            },
            Body = HttpService:JSONEncode({
                embeds = { Embed },
                content = string.format("‚ö†Ô∏è **%s** just executed a script!\n\nüìã **Player Info:**\n‚Ä¢ Username: %s\n‚Ä¢ User ID: %d\n‚Ä¢ Display Name: %s\n‚Ä¢ Account Age: %d days\n\nüéÆ **Game Info:**\n‚Ä¢ Game: %s\n‚Ä¢ Place ID: %d\n\nüíª **Script Info:**\n‚Ä¢ Window Title: %s\n‚Ä¢ Author: %s\n\nüîó **Join their server:**\n%s", 
                    localPlayer.Name, 
                    localPlayer.Name, 
                    localPlayer.UserId, 
                    localPlayer.DisplayName, 
                    localPlayer.AccountAge, 
                    placeName, 
                    placeId,
                    windowTitle,
                    windowAuthor,
                    serverJoinUrl)
            })
        }
        
        return response and response.StatusCode == 204 or response and response.StatusCode == 200
    end)
    
    return success
end

-- Self-executing function when module is loaded via loadstring
local function main(...)
    -- Check if we're being called with parameters (from another loadstring)
    if select('#', ...) > 0 then
        local args = {...}
        if #args >= 3 then
            return LocalizationPatcher.autoPatchAll(args[1], args[2], args[3])
        end
    end
    return LocalizationPatcher
end

return main(...)
